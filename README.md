# sourcefinding
Various programs/tools for source finding and cleaning of Apertif HI cubes


### Step 1: sourcefinding.py
```
python sourcefinding.py -t <taskid> -b <beams> -c <cubes> -o <optionally overwrites continuum filtered file>
```
Default for beams is 0-39 (all).  
Default for cubes is 1,2,3 (nearest cubes where we expect direct detections).  
Only does a single source finding.  Super bright sources with sidelobes need to be identified in the next step.

First does continuum filtering in SoFiA-2 using `template_filtering.par`.  This is separate so it only has to be done once, but source finding can be repeated without recreating the same continuum filtered file over and over again. For source finding, uses a parameter file called `parameter_template_4sig.par`.

After source finding, calls `src/checkmasks.py` to plot the mask from continuum filtering (in grey) and the 2D masks of the source finding (in color) for the nearest 3 cubes or ignores if they aren't present.  Plots the integrated spectrum for all sources.

Output:  
`HI_image_cube*_filtered.fits` - used for plotting  
`HI_image_cube*_4sig_cat.txt` - used in `clean.py`
`HI_image_cube*_4sig_chan.fits`  
`HI_image_cube*_4sig_mask-2d.fits` - used in `checkmasks.py`  
`HI_image_cube*_4sig_mask.fits` - used for plotting
`HI_image_cube*_4sig_rel.eps `

`HI_imaging_4sig_summary.png` - plot of continuum & 2D masks
`HI_imaging_4sig_summary_spec.png` - plot of spectra  


\**PLOTS SHOULD BE VISUALLY INSPECTED TO DETERMINE THE RIGHT WAY TO RUN `clean.py`.\**


### Step 2: clean.py
```
python clean.py -t <taskid> -b <beams> -c <cubes> -s <sources> -o <optionally overwrites prev clean/model/residual FITS files.>
```
Default for beams is 0-39 (all).  
Default for cubes is 1,2,3 (nearest cubes where we expect direct detections).  
Ignores beam/cube combinations which don't have a SoFiA mask generated by sourcefinding.py.  (If a catalog file is present, but not mask, program crashes out.  Means something went wrong with `sourcefinding.py`.)

Cleans the HI emission based on input mask files and user source selection.  Source selection can be done from command line.  Program just takes the output mask from SoFiA results and cleans with that to 0.5 sigma.

Generates a catalog of what SoFiA sources have been cleaned, for each \*beam*.  (e.g. Results for all cubes are summarized in one file per beam in beam directory.)  If run multiple times, one needs to sort and clean the catalog file by hand.

Output:  
`HI_image_cube*_clean.fits` - cleaned cube  
`HI_image_cube*_model.fits` - model cube  
`HI_image_cube*_residual.fits` - residual cube  
`clean_cat.txt` - modified version of SoFiA output catalog, appended with taskid, beam, cube numbers.


### Step 3: finalsources.py
```
python finalsources.py -t <taskid> -b <beams> -c <cubes>
```
Same defaults as above.  
Uses SoFiA-1 submodule to create FITS subcubes/maps based on the existing SoFiA masks and cleaned cubes for every CLEANED source (if it meets selection criteria and lives in clean_cat.txt) including all moment maps, a position velocity slice along the SoFiA determined kinematic major axis, and an ascii text file of the integrated spectrum in the 3D mask.

Calculates physical properties of detected sources and stores them in final_cat.txt which is stored at the taskid level! (Combines results for all beams/cubes!)  If run multiple times on same beam/cube combos, one needs to sort and clean the catalog file by hand.  SoFiA source name is replaced with the position derived source name.

Creates png images including an HI contour overlay on a DSS2 Blue image, intensity weighted velocity map, postion-velocity through SoFiA kinematic major axis, and an ascii text file of integrated HI spectrum over 2D mask.  All pngs, fits, txt files are saved at beam level. BB = beam number; C = cube number; S = SoFiA original source number (combo is unique & can reference back to `clean_cat.txt` and `HI_image_cubeC_4sig_cat.txt`)

Output:  
`AHC_Jhhmmss.s+ddmmss_TASKID_BB_C_S.fits` - subcube
`AHC_Jhhmmss.s+ddmmss_TASKID_BB_C_S_mom0.fits`
`AHC_Jhhmmss.s+ddmmss_TASKID_BB_C_S_mom1.fits`
`AHC_Jhhmmss.s+ddmmss_TASKID_BB_C_S_mom2.fits`
`AHC_Jhhmmss.s+ddmmss_TASKID_BB_C_S_pv.fits`
`AHC_Jhhmmss.s+ddmmss_TASKID_BB_C_S_spec.txt` - SoFiA generated spectrum

`AHC_Jhhmmss.s+ddmmss_TASKID_BB_C_S_mom0.png` - HI contours on DSS2 Blue image
`AHC_Jhhmmss.s+ddmmss_TASKID_BB_C_S_mom1.png`
`AHC_Jhhmmss.s+ddmmss_TASKID_BB_C_S_pv.png`
`AHC_Jhhmmss.s+ddmmss_TASKID_BB_C_S_specfull.txt` - Integrated spectrum over 2D mask

`final_cat.txt` - Source catalog with physically derived source properties