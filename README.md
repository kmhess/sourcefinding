# sourcefinding
Various programs/tools for source finding and cleaning of Apertif HI cubes


### Step 1: sourcefinding.py
```
python sourcefinding.py -t <taskid> -b <beams> -c <cubes> -o <optionally overwrites continuum filtered file>
```
Default for beams is 0-39 (all).  
Default for cubes is 1,2,3 (nearest cubes where we expect direct detections).
First does continuum filtering in SoFiA-2 using `template_filtering.par`.  This is separate so it only has to be done once, but source finding can be repeated without recreating the same continuum filtered file over and over again. For source finding, uses a parameter file called `parameter_template_4sig.par`.
Only does a single source finding.  Super bright sources with sidelobes need to be identified in the next step.

Output:  
`HI_image_cube*_filtered.fits` - used in `checkmasks.py`  
`HI_image_cube*_4sig_cat.txt`  
`HI_image_cube*_4sig_chan.fits`  
`HI_image_cube*_4sig_mask-2d.fits` - used in `checkmasks.py`  
`HI_image_cube*_4sig_mask.fits` - used in `clean.py`  
`HI_image_cube*_4sig_rel.eps `  

### Step 2: checkmasks.py
```
python checkmasks.py -t <taskid> -b <beams>
```
Default for beams is 0-39 (all).  
Plots the mask from continuum filtering (in grey) and the 2D masks of the source finding (in color) for the nearest 3 cubes or ignores if they aren't present.
Plots the HI spectrum for all sources found in `sourcefinding.py`.

Output: `HI_imaging_4sig_summary.png` and `HI_imaging_4sig_summary_spec.png`.  

### Step 3: clean.py
```
python clean.py -t <taskid> -b <beams> -c <cubes> -s <sources> -o <optionally overwrites prev clean/model/residual FITS files.>
```
Default for beams is 0-39 (all).  
Default for cubes is 1,2,3 (nearest cubes where we expect direct detections).  
Ignores beam/cube combinations which don't have a SoFiA mask generated by sourcefinding.py.  (If a catalog file is present, but not mask, program crashes out.  Means something went wrong with `sourcefinding.py`.)
Cleans the HI emission based on input mask files and user source selection.  Source selection can be done from command line.  Program just takes the output mask from SoFiA results and cleans with that to 0.5 sigma.  
Generates a catalog of what SoFiA sources have been cleaned, for each \*beam*.  (e.g. Results for all cubes are summarized in one file.)  If run multiple times, one needs to sort and clean the catalog file by hand.

Output:  
`HI_image_cube*_clean.fits` cleaned cube  
`HI_image_cube*_model.fits` model cube  
`HI_image_cube*_residual.fits` residual cube  
`clean_cat.txt` modified version of SoFiA output catalog, prepended with taskid, beam, cube numbers.

### Step 4: finalsources.py
```
python finalsources.py -t <taskid> -b <beams> -c <cubes>
```
Same defaults as above.  Create moment maps based on the existing SoFiA masks, cleaned cubes, and the sources in the clean catalog.  Produces subimages for all moments, an HI contour overlay on a DSS2 Blue image, and an ascii text file for the HI profiles of each source.  Clean beam data is stored in the comments of the text file.  It can be accessed, for example, with `a.meta['comments'][0].replace('= ','').split()`
